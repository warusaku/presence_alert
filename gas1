/**
 * Omada Webhook å—ä¿¡ç”¨ (Google Apps Script) - ä¿®æ­£ç‰ˆ
 * 2025-07-10 å‡ºå‹¤ç°¿é€£æºãƒ»Discordé€šçŸ¥å¯¾å¿œç‰ˆ
 */

function doPost(e) {
  /* ---------- 1. å—ä¿¡ ---------- */
  const raw     = (e.postData && e.postData.contents) ? e.postData.contents : '{}';
  const payload = _safeJson_(raw);

  /* ---------- 2. ãƒ­ã‚°ä¿å­˜ï¼ˆå…¨ä»¶ï¼‰ ---------- */
  _writeLog_(payload);

  /* ---------- 3. MAC / ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ / IP / æ™‚åˆ» æŠ½å‡º ---------- */
  const info = _extractInfo_(payload);
  if (!info.macRaw || !info.status) return _ok_();

  const macNorm = _normalizeMac_(info.macRaw);

  /* ---------- 4. mac ã‚·ãƒ¼ãƒˆç…§åˆ ---------- */
  const ss        = SpreadsheetApp.getActiveSpreadsheet();
  const macSheet  = ss.getSheetByName('mac') || ss.insertSheet('mac');
  const macData   = _getMacData_(macSheet);
  
  if (!macData.has(macNorm)) return _ok_();
  
  const macInfo   = macData.get(macNorm);
  const dispName  = macInfo.displayName;
  const username  = macInfo.username;
  const endpoint  = macInfo.gasEndpoint;
  const webhook   = macInfo.discordWebhook;

  /* ---------- 5. data ã‚·ãƒ¼ãƒˆã¸æ›¸ãè¾¼ã¿ ---------- */
  const dataSheet = ss.getSheetByName('data') || ss.insertSheet('data');
  const newRow = [
    info.eventDate,
    info.macRaw.toUpperCase(),
    dispName,
    info.status,
    info.ip || '',
    JSON.stringify(payload)
  ];
  dataSheet.appendRow(newRow);

  /* ---------- 6. å‡ºå‹¤åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---------- */
  const judgmentResult = _judgeAttendance_(dataSheet, macSheet, username, info.status, info.eventDate);
  
  /* ---------- 7. å‡ºå‹¤ç°¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸é€ä¿¡ ---------- */
  if (endpoint) {
    const postData = {
      username: username,
      timestamp: _formatDateTime_(info.eventDate),
      state: info.status,
      name: username,
      devicename: dispName,
      ipaddr: info.ip || '',
      MAC: info.macRaw.toUpperCase(),
      description: judgmentResult.description
    };
    
    try {
      UrlFetchApp.fetch(endpoint, {
        method: 'post',
        contentType: 'application/json',
        payload: JSON.stringify(postData)
      });
    } catch(e) {
      console.error('å‡ºå‹¤ç°¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®é€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  /* ---------- 8. Discordé€šçŸ¥ ---------- */
  if (webhook) {
    _sendDiscordNotification_(webhook, username, dispName, info.status, judgmentResult.description, info.eventDate);
  }

  return _ok_();
}

/* ================================================================= */
/* å‡ºå‹¤åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ------------------------------------------------- */
/* ================================================================= */

function _judgeAttendance_(dataSheet, macSheet, username, currentStatus, eventDate) {
  const lastRow = dataSheet.getLastRow();
  if (lastRow <= 1) {
    return currentStatus === 'ONLINE' 
      ? {description: 'å‡ºå‹¤(æœ€åˆã®ã‚¨ãƒ³ãƒˆãƒª)'} 
      : {description: 'OFFLINE(æœ€åˆã®ã‚¨ãƒ³ãƒˆãƒª)'};
  }

  // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆæœ€æ–°ã®ã‚‚ã®ã‹ã‚‰å‡¦ç†ï¼‰
  const allData = dataSheet.getRange(2, 1, lastRow - 1, 6).getValues().reverse();
  const macData = _getMacData_(macSheet);
  
  // åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
  const userDevices = _getUserDevices_(macData, username);
  
  // ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
  const currentDateStr = _formatDate_(eventDate);
  
  // åŒä¸€æ—¥ã®åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¨ãƒ³ãƒˆãƒªã‚’æ¤œç´¢
  let sameDayEntry = null;
  let previousEntry = null;
  let otherDeviceOnline = false;
  
  for (let i = 0; i < allData.length; i++) {
    const row = allData[i];
    const rowDate = row[0];
    const rowMac = _normalizeMac_(row[1]);
    const rowStatus = row[3];
    
    // MACã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
    const rowUserInfo = macData.get(rowMac);
    if (!rowUserInfo) continue;
    
    const rowUsername = rowUserInfo.username;
    const rowDateStr = _formatDate_(rowDate);
    
    // åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
    if (rowUsername === username) {
      // åˆ¥ãƒ‡ãƒã‚¤ã‚¹ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‹ãƒã‚§ãƒƒã‚¯
      if (rowMac !== _normalizeMac_(dataSheet.getRange(lastRow, 2).getValue()) && 
          rowStatus === 'ONLINE' && 
          rowDateStr === currentDateStr) {
        otherDeviceOnline = true;
      }
      
      // åŒä¸€æ—¥ã®ã‚¨ãƒ³ãƒˆãƒª
      if (rowDateStr === currentDateStr && !sameDayEntry) {
        sameDayEntry = {row: row, index: i};
      }
      
      // å‰ã®ã‚¨ãƒ³ãƒˆãƒªï¼ˆæ—¥ä»˜å•ã‚ãšï¼‰
      if (!previousEntry) {
        previousEntry = {row: row, index: i, dateStr: rowDateStr};
      }
    }
  }
  
  // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
  let description = '';
  
  if (!sameDayEntry) {
    // åŒä¸€æ—¥ã®ã‚¨ãƒ³ãƒˆãƒªãŒãªã„å ´åˆ
    if (currentStatus === 'ONLINE') {
      description = 'å‡ºå‹¤(æœ€åˆã®ã‚¨ãƒ³ãƒˆãƒª)';
      
      // å‰æ—¥æœ€å¾Œã®OFFLINEã‚’é€€å‹¤ã¨åˆ¤å®š
      if (previousEntry && previousEntry.row[3] === 'OFFLINE' && previousEntry.dateStr !== currentDateStr) {
        const rowIndex = lastRow - previousEntry.index - 1;
        dataSheet.getRange(rowIndex, 7).setValue('å‰æ—¥æœ€å¾Œã®OFFLINE=é€€å‹¤ã¨åˆ¤å®š');
      }
    } else {
      description = 'OFFLINE(æœ¬æ—¥ã®æœ€åˆã®ã‚¨ãƒ³ãƒˆãƒª)';
    }
  } else {
    // åŒä¸€æ—¥ã®ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚‹å ´åˆ
    if (currentStatus === 'OFFLINE') {
      description = 'OFFLINE=ãƒ‡ãƒã‚¤ã‚¹ãŒwifiã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ';
    } else if (currentStatus === 'ONLINE') {
      // å‰å›ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
      const prevStatus = sameDayEntry.row[3];
      if (prevStatus === 'OFFLINE') {
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨ˆç®—
        const interval = _calculateInterval_(sameDayEntry.row[0], eventDate);
        description = `ONLINEã«å¾©å¸°ã—ã¾ã—ãŸ interval=${interval}`;
      } else {
        description = 'ONLINEã«å¾©å¸°ã—ã¾ã—ãŸå‰å›OFFLINEãŒè¨˜éŒ²ã•ã‚Œã¦ã¾ã›ã‚“';
      }
    }
  }
  
  // åˆ¥ãƒ‡ãƒã‚¤ã‚¹ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®å ´åˆ
  if (otherDeviceOnline && currentStatus === 'ONLINE') {
    description += ' //åˆ¥ã®ç«¯æœ«ã§ã¯ã™ã§ã«ONLINEã¸å¾©å¸°æ¸ˆã¿';
  }
  
  return {description: description};
}

/* ================================================================= */
/* Discordé€šçŸ¥ ----------------------------------------------------- */
/* ================================================================= */

function _sendDiscordNotification_(webhook, username, devicename, status, description, eventDate) {
  const color = status === 'ONLINE' ? 0x00ff00 : 0xff0000;
  const statusEmoji = status === 'ONLINE' ? 'ğŸŸ¢' : 'ğŸ”´';
  
  const embed = {
    embeds: [{
      title: `${statusEmoji} ${username} - ${status}`,
      description: description,
      color: color,
      fields: [
        {
          name: 'ãƒ‡ãƒã‚¤ã‚¹å',
          value: devicename,
          inline: true
        },
        {
          name: 'æ™‚åˆ»',
          value: _formatDateTime_(eventDate),
          inline: true
        }
      ],
      timestamp: eventDate.toISOString()
    }]
  };
  
  try {
    UrlFetchApp.fetch(webhook, {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(embed)
    });
  } catch(e) {
    console.error('Discordé€šçŸ¥ã‚¨ãƒ©ãƒ¼:', e);
  }
}

/* ================================================================= */
/* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ----------------------------------------------- */
/* ================================================================= */

function _ok_(){
  // OmadaãŒæœŸå¾…ã™ã‚‹å½¢å¼ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
  const response = ContentService.createTextOutput(JSON.stringify({
    status: 'success',
    message: 'Webhook received successfully'
  }));
  
  response.setMimeType(ContentService.MimeType.JSON);
  
  // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ˜ç¤ºçš„ã«200ã«è¨­å®š
  return response;
}

function _safeJson_(txt){
  try { return JSON.parse(txt); }
  catch(e){ return { parseError: e.toString(), raw: txt }; }
}

function _normalizeMac_(m){
  return m.replace(/[^0-9A-Fa-f]/g,'').toUpperCase();
}

function _eventStatus_(msg=''){
  const m = msg.toLowerCase();
  if (m.includes('went online') || m.includes('online')  || m.includes('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'))  return 'ONLINE';
  if (m.includes('went offline')|| m.includes('offline') || m.includes('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³')) return 'OFFLINE';
  return '';
}

function _getMacData_(sheet){
  const rows = sheet.getLastRow();
  if (rows === 0) return new Map();

  const vals = sheet.getRange(1, 1, rows, 5).getValues();
  const map  = new Map();
  vals.forEach(r => {
    if (r[0]) {
      map.set(_normalizeMac_(r[0]), {
        displayName: r[1] || '',
        gasEndpoint: r[2] || '',
        username: r[3] || '',
        discordWebhook: r[4] || ''
      });
    }
  });
  return map;
}

function _getUserDevices_(macData, username) {
  const devices = [];
  macData.forEach((value, key) => {
    if (value.username === username) {
      devices.push(key);
    }
  });
  return devices;
}

function _writeLog_(payload){
  const ss    = SpreadsheetApp.getActiveSpreadsheet();
  const logSh = ss.getSheetByName('log') || ss.insertSheet('log');
  logSh.appendRow([new Date(), JSON.stringify(payload)]);
}

function _extractInfo_(obj){
  let macRaw = '', status = '', ip = '';

  if (obj.data && obj.data.clientMac){
    macRaw = obj.data.clientMac;
    ip     = obj.data.clientIp || '';
    status = _eventStatus_(obj.msg || '');
  } else if (Array.isArray(obj.text) && obj.text[0]){
    const line = obj.text[0];
    macRaw = (line.match(/client:[^:\]]+:([0-9A-Fa-f:-]+)/) || [])[1] || '';
    ip     = (line.match(/IP:\s*([0-9.]+)/)               || [])[1] || '';
    status = _eventStatus_(line);
  }

  const ms        = Number(obj.timestamp) || Date.now();
  let   eventDate = new Date(ms);

  return { macRaw, status, ip, eventDate };
}

function _formatDate_(date) {
  return Utilities.formatDate(date, 'Asia/Tokyo', 'yyyy/MM/dd');
}

function _formatDateTime_(date) {
  return Utilities.formatDate(date, 'Asia/Tokyo', 'yyyy/MM/dd HH:mm:ss');
}

function _calculateInterval_(startDate, endDate) {
  const diff = endDate.getTime() - startDate.getTime();
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((diff % (1000 * 60)) / 1000);
  
  return `${hours}æ™‚é–“${minutes}åˆ†${seconds}ç§’`;
}

/* ================================================================= */
/* ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°ï¼ˆé–‹ç™ºæ™‚ã®ã¿ä½¿ç”¨ï¼‰ ------------------------------------ */
/* ================================================================= */

function testSetup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // macã‚·ãƒ¼ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  const macSheet = ss.getSheetByName('mac') || ss.insertSheet('mac');
  if (macSheet.getLastRow() === 0) {
    macSheet.getRange(1, 1, 1, 5).setValues([
      ['MACã‚¢ãƒ‰ãƒ¬ã‚¹', 'ãƒ‡ãƒã‚¤ã‚¹å', 'GASã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', 'Discord Webhook']
    ]);
  }
  
  // dataã‚·ãƒ¼ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  
  const dataSheet = ss.getSheetByName('data') || ss.insertSheet('data');
  if (dataSheet.getLastRow() === 0) {
    dataSheet.getRange(1, 1, 1, 7).setValues([
      ['ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—', 'MAC', 'è¡¨ç¤ºå', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'IP', 'å…ƒJSON', 'åˆ¤å®šå†…å®¹']
    ]);
  }
  
  // logã‚·ãƒ¼ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  const logSheet = ss.getSheetByName('log') || ss.insertSheet('log');
  if (logSheet.getLastRow() === 0) {
    logSheet.getRange(1, 1, 1, 2).setValues([
      ['å—ä¿¡æ™‚åˆ»', 'ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰']
    ]);
  }
}

/**
 * Webhookå‹•ä½œç¢ºèªç”¨é–¢æ•°
 * Omadaã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
 */
function testWebhook() {
  const testPayload = {
    postData: {
      contents: JSON.stringify({
        timestamp: Date.now(),
        data: {
          clientMac: "AA:BB:CC:DD:EE:FF",
          clientIp: "192.168.1.100"
        },
        msg: "Client AA:BB:CC:DD:EE:FF went online"
      })
    }
  };
  
  const result = doPost(testPayload);
  console.log('Test Result:', result.getContent());
}